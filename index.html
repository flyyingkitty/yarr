<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat about random things lol</title>
    <style>
        :root {
            --xp-bg: #ECE9D8;
            --xp-blue: #0055E7;
            --xp-blue-gradient-end: #3B93FF;
            --xp-text: #000000;
            --xp-window-border: #ACA899;
            --xp-desktop-bg: #3A6EA5;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        body {
            font-family: Tahoma, Geneva, sans-serif;
            font-size: 11px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--xp-desktop-bg);
            color: var(--xp-text);
            animation: fadeIn 0.3s ease-in;
        }
        .app-container {
            width: 100%;
            max-width: 640px;
            height: 90vh;
            max-height: 700px;
            background-color: var(--xp-bg);
            border: 1px solid var(--xp-window-border);
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px outset #fff;
        }
        .hidden { display: none !important; }

        .title-bar {
            background: linear-gradient(to bottom, var(--xp-blue), var(--xp-blue-gradient-end));
            color: #fff;
            padding: 4px 6px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        #auth-view { padding: 30px; display: flex; flex-direction: column; justify-content: center; height: 100%; background-color: var(--xp-bg); }
        .auth-form { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .auth-form input {
            padding: 5px;
            font-family: Tahoma, sans-serif;
            font-size: 11px;
            border: 1px solid var(--xp-window-border);
            box-shadow: inset 1px 1px 2px #777;
            background-color: #fff;
        }
        .auth-button {
            font-family: Tahoma, sans-serif;
            font-size: 11px;
            padding: 5px 15px;
            background-color: var(--xp-bg);
            border: 2px outset #fff;
            cursor: pointer;
        }
        .auth-button:active { border-style: inset; }
        .form-actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        #auth-error { color: #A00; text-align: center; min-height: 20px; margin-top: 10px; }
        .form-toggle { color: #0000EE; cursor: pointer; text-decoration: underline; text-align: center; margin-top: 15px; }

        #chat-view { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #profile-area { display: flex; align-items: center; gap: 8px; cursor: pointer; border: 1px solid transparent; padding: 2px; }
        #profile-area:hover { border: 1px dotted #fff; }
        #profile-pfp { width: 24px; height: 24px; border: 1px inset #fff; }
        
        #profile-dropdown {
            position: absolute;
            top: 32px;
            right: 5px;
            background-color: var(--xp-bg);
            border: 2px outset #fff;
            box-shadow: 2px 2px 3px rgba(0,0,0,0.3);
            z-index: 100;
        }
        .dropdown-item { padding: 5px 25px 5px 15px; cursor: pointer; }
        .dropdown-item:hover { background-color: var(--xp-blue); color: #fff; }

        #message-display {
            flex-grow: 1;
            padding: 10px;
            overflow-y: scroll;
            background-color: #fff;
            border-top: 1px solid var(--xp-window-border);
            border-bottom: 1px solid var(--xp-window-border);
            box-shadow: inset 1px 1px 2px #777;
        }
        .message { display: flex; align-items: flex-start; gap: 8px; padding: 3px 0; }
        .message-pfp { width: 32px; height: 32px; border: 1px inset #ccc; flex-shrink: 0; }
        .message-body { display: flex; flex-direction: column; }
        .sender-name { font-weight: bold; }
        .message.mine .sender-name { color: #0000C8; }
        .message.other .sender-name { color: #C80000; }
        
        #message-form { display: flex; padding: 10px; gap: 10px; align-items: center; }
        #message-input { flex-grow: 1; font-family: Tahoma, sans-serif; padding: 5px; border: 1px solid var(--xp-window-border); box-shadow: inset 1px 1px 2px #777; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: var(--xp-bg); padding: 2px; border: 2px outset #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); }
        .modal-content .title-bar { cursor: move; }
        .modal-body { padding: 20px; }

        #warning-window {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 250px;
            background-color: var(--xp-bg);
            border: 2px outset #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            z-index: 500;
        }
        #warning-window .title-bar { background: linear-gradient(to bottom, #F99B1D, #FEBD54); }
        #warning-window .modal-body { display: flex; align-items: flex-start; gap: 10px; }
        #warning-window .warning-icon { font-size: 24px; color: #F99B1D; }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="auth-view">
            <div id="login-form">
                <div class="title-bar">User Login</div>
                <form class="auth-form" style="padding: 20px;">
                    <label for="login-username">Username:</label>
                    <input type="text" id="login-username" required>
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" required>
                    <div class="form-actions"><button type="button" id="login-btn" class="auth-button">Log In</button></div>
                </form>
                <p id="login-form-toggle" class="form-toggle">Create a new account</p>
            </div>
            <div id="signup-form" class="hidden">
                <div class="title-bar">Create New Account</div>
                <form class="auth-form" style="padding: 20px;">
                    <label for="signup-username">Username:</label>
                    <input type="text" id="signup-username" required>
                    <label for="signup-email">Email:</label>
                    <input type="email" id="signup-email" required>
                    <label for="signup-password">Password:</label>
                    <input type="password" id="signup-password" required>
                    <div class="form-actions"><button type="button" id="signup-btn" class="auth-button">Sign Up</button></div>
                </form>
                <p id="signup-form-toggle" class="form-toggle">Return to Login</p>
            </div>
            <p id="auth-error"></p>
        </div>

        <div id="chat-view" class="hidden">
            <header class="title-bar">
                <span>Chat about random things lol</span>
                <div id="profile-area">
                    <span id="profile-username"></span>
                    <img id="profile-pfp" src="" alt="PFP">
                </div>
            </header>
            <div id="profile-dropdown" class="hidden">
                <div class="dropdown-item" id="change-username-btn">Change Username...</div>
                <div class="dropdown-item" id="change-pfp-btn">Change Picture...</div>
                <hr style="border: 0; border-top: 1px solid #999; margin: 0;">
                <div class="dropdown-item" id="sign-out-btn">Sign Out</div>
            </div>
            <main id="message-display"></main>
            <form id="message-form">
                <input type="text" id="message-input" autocomplete="off">
                <button type="submit" class="auth-button">Send</button>
            </form>
        </div>
    </div>
    
    <input type="file" id="pfp-upload-input" class="hidden" accept="image/*">
    <div id="username-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="title-bar">Change Username</div>
            <div class="modal-body">
                <label for="new-username-input">Enter new username:</label>
                <input type="text" id="new-username-input" style="margin-top: 5px;">
                <div style="text-align: center; margin-top: 15px;">
                    <button id="confirm-username-change" class="auth-button">OK</button>
                    <button id="cancel-username-change" class="auth-button">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="warning-window">
        <div class="title-bar">Warning</div>
        <div class="modal-body">
            <span class="warning-icon">!</span>
            <span>Theres a lot of bugs that need to be fixed so just keep in mind that its not perfect</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, set, get, push, onChildAdded, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIFtz1SKI5zm-IQUJ1yNILX_CvT7yUAQg",
            authDomain: "flyyingkittyyarrr.firebaseapp.com",
            databaseURL: "https://flyyingkittyyarrr-default-rtdb.firebaseio.com",
            projectId: "flyyingkittyyarrr",
            storageBucket: "flyyingkittyyarrr.appspot.com",
            messagingSenderId: "92004323057",
            appId: "1:92004323057:web:af8a781dfd17e9d7e3a350",
            measurementId: "G-NCL7SJC998"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);
        
        let messageListener = null;
        const messagesRef = ref(db, 'messages');

        const authView = document.getElementById('auth-view');
        const chatView = document.getElementById('chat-view');
        const authError = document.getElementById('auth-error');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const signupForm = document.getElementById('signup-form');
        const signupBtn = document.getElementById('signup-btn');
        const signupUsernameInput = document.getElementById('signup-username');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        document.getElementById('login-form-toggle').addEventListener('click', () => { loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
        document.getElementById('signup-form-toggle').addEventListener('click', () => { signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        const profileArea = document.getElementById('profile-area');
        const profilePfp = document.getElementById('profile-pfp');
        const profileUsername = document.getElementById('profile-username');
        const profileDropdown = document.getElementById('profile-dropdown');
        const messageDisplay = document.getElementById('message-display');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const signOutBtn = document.getElementById('sign-out-btn');
        const changePfpBtn = document.getElementById('change-pfp-btn');
        const pfpUploadInput = document.getElementById('pfp-upload-input');
        const changeUsernameBtn = document.getElementById('change-username-btn');
        const usernameModal = document.getElementById('username-modal');
        const newUsernameInput = document.getElementById('new-username-input');
        const confirmUsernameChange = document.getElementById('confirm-username-change');
        const cancelUsernameChange = document.getElementById('cancel-username-change');
        const DEFAULT_PFP_URL = "https://i.ibb.co/6yT4R2v/default-pfp.png";

        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                chatView.classList.remove('hidden');
                updateProfileUI(user);
                messageDisplay.innerHTML = ''; 
                startChatListener();
            } else {
                authView.classList.remove('hidden');
                chatView.classList.add('hidden');
                stopChatListener();
            }
        });

        signupBtn.addEventListener('click', async () => {
            const username = signupUsernameInput.value.trim();
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            authError.textContent = '';
            if (!username || !email || !password) return alert("All fields are required.");
            const usernameRef = ref(db, `usernames/${username.toLowerCase()}`);
            const usernameSnapshot = await get(usernameRef);
            if (usernameSnapshot.exists()) return authError.textContent = "Username is already taken.";
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: username, photoURL: DEFAULT_PFP_URL });
                await set(ref(db, `users/${user.uid}`), { username: username, email: user.email, photoURL: DEFAULT_PFP_URL });
                await set(ref(db, `usernames/${username.toLowerCase()}`), { uid: user.uid });
            } catch (error) { authError.textContent = error.message; }
        });
        
        loginBtn.addEventListener('click', async () => {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value;
            authError.textContent = '';
            if (!username || !password) return;
            try {
                const usernameRef = ref(db, `usernames/${username.toLowerCase()}`);
                const usernameSnapshot = await get(usernameRef);
                if (!usernameSnapshot.exists()) throw new Error("User not found.");
                const { uid } = usernameSnapshot.val();
                const userRef = ref(db, `users/${uid}`);
                const userSnapshot = await get(userRef);
                if (!userSnapshot.exists()) throw new Error("User data is inconsistent.");
                const { email } = userSnapshot.val();
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { authError.textContent = error.message; }
        });

        signOutBtn.addEventListener('click', () => signOut(auth));
        
        profileArea.addEventListener('click', () => profileDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (e) => {
            if (!profileArea.contains(e.target) && !profileDropdown.classList.contains('hidden')) {
                profileDropdown.classList.add('hidden');
            }
        });

        changePfpBtn.addEventListener('click', () => pfpUploadInput.click());
        pfpUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const user = auth.currentUser;
            if (!file || !user) return;
            const filePath = `profile_pictures/${user.uid}/${Date.now()}_${file.name}`;
            const fileRef = storageRef(storage, filePath);
            try {
                await uploadBytes(fileRef, file);
                const photoURL = await getDownloadURL(fileRef);
                await updateProfile(user, { photoURL });
                await set(ref(db, `users/${user.uid}/photoURL`), photoURL);
                updateProfileUI(user);
            } catch(error) { alert("Error uploading file: " + error.message); }
            profileDropdown.classList.add('hidden');
        });

        changeUsernameBtn.addEventListener('click', () => { usernameModal.classList.remove('hidden'); profileDropdown.classList.add('hidden'); });
        cancelUsernameChange.addEventListener('click', () => usernameModal.classList.add('hidden'));
        confirmUsernameChange.addEventListener('click', async () => {
            const newUsername = newUsernameInput.value.trim();
            const user = auth.currentUser;
            if (!newUsername || !user) return;
            if (newUsername === user.displayName) return usernameModal.classList.add('hidden');
            const newUsernameRef = ref(db, `usernames/${newUsername.toLowerCase()}`);
            const snapshot = await get(newUsernameRef);
            if(snapshot.exists()) return alert("Username already taken.");
            const oldUsername = user.displayName;
            try {
                await updateProfile(user, { displayName: newUsername });
                await set(ref(db, `users/${user.uid}/username`), newUsername);
                await set(ref(db, `usernames/${newUsername.toLowerCase()}`), { uid: user.uid });
                await set(ref(db, `usernames/${oldUsername.toLowerCase()}`), null);
                updateProfileUI(user);
                alert("Username updated successfully!");
            } catch(error) { alert("Error updating username: " + error.message); }
            usernameModal.classList.add('hidden');
        });

        function startChatListener() {
            stopChatListener();
            messageListener = onChildAdded(messagesRef, (snapshot) => {
                displayMessage(snapshot.val());
            });
        }
        
        function stopChatListener() {
            if (messageListener) {
                off(messagesRef, 'child_added', messageListener);
                messageListener = null;
            }
        }
        
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            const user = auth.currentUser;
            if (messageText && user) {
                push(messagesRef, {
                    text: messageText,
                    senderName: user.displayName,
                    senderId: user.uid,
                    senderPfp: user.photoURL || DEFAULT_PFP_URL,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
            }
        });

        function updateProfileUI(user) {
            profilePfp.src = user.photoURL || DEFAULT_PFP_URL;
            profileUsername.textContent = user.displayName;
        }

        function displayMessage(msg) {
            const user = auth.currentUser;
            if (!user) return;
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', msg.senderId === user.uid ? 'mine' : 'other');
            msgDiv.innerHTML = `
                <img src="${msg.senderPfp || DEFAULT_PFP_URL}" alt="PFP" class="message-pfp">
                <div class="message-body">
                    <span class="sender-name">${msg.senderName}:</span>
                    <span>${msg.text}</span>
                </div>
            `;
            messageDisplay.appendChild(msgDiv);
            messageDisplay.scrollTop = messageDisplay.scrollHeight;
        }
    </script>
</body>
</html>
